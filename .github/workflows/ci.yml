name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Copy environment file
        run: |
          cp .env.ci .env

      - name: Check Docker Compose syntax
        run: |
          docker compose config --quiet

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Copy environment file
        run: |
          cp .env.ci .env

      - name: Start services
        run: |
          docker compose up -d
          echo "Checking container status..."
          sleep 10
          docker compose ps

      - name: Check for failed containers
        run: |
          FAILED=$(docker compose ps -a --format json | jq -r 'select(.State != "running") | .Name' 2>/dev/null || true)
          if [ -n "$FAILED" ]; then
            echo "Failed containers detected: $FAILED"
            for container in $FAILED; do
              echo "=== Logs for $container ==="
              docker compose logs --tail=100 "$container" || true
            done
            echo "Container status:"
            docker compose ps -a
            exit 1
          fi

      - name: Show galaxy-migrate logs if it fails
        if: failure()
        run: docker compose logs --tail=100 galaxy-migrate

      - name: Wait for PostgreSQL
        run: |
          echo "Waiting for PostgreSQL..."
          for i in {1..30}; do
            if docker exec galaxy-postgres pg_isready -U galaxy > /dev/null 2>&1; then
              echo "PostgreSQL is ready!"
              exit 0
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 2
          done
          echo "PostgreSQL failed to start"
          docker compose logs postgres
          exit 1

      - name: Wait for Redis
        run: |
          echo "Waiting for Redis..."
          for i in {1..15}; do
            if docker exec galaxy-redis redis-cli -a galaxy ping > /dev/null 2>&1; then
              echo "Redis is ready!"
              exit 0
            fi
            echo "Waiting for Redis... ($i/15)"
            sleep 2
          done
          echo "Redis failed to start"
          docker compose logs redis
          exit 1

      - name: Wait for Galaxy API
        run: |
          echo "Waiting for Galaxy API..."
          for i in {1..60}; do
            if curl -sf http://localhost:8000/api/galaxy/pulp/api/v3/status/ > /dev/null 2>&1; then
              echo "Galaxy API is ready!"
              exit 0
            fi
            echo "Waiting for Galaxy API... ($i/60)"
            sleep 5
          done
          echo "Galaxy API failed to start"
          docker compose logs galaxy-api
          exit 1

      - name: Verify Galaxy API status
        run: |
          echo "=== Galaxy API Status ==="
          curl -s http://localhost:8000/api/galaxy/pulp/api/v3/status/ | jq '.'

      - name: Verify database connection
        run: |
          DB_STATUS=$(curl -s http://localhost:8000/api/galaxy/pulp/api/v3/status/ | jq -r '.database_connection.connected')
          echo "Database connected: $DB_STATUS"
          if [ "$DB_STATUS" != "true" ]; then
            echo "Database connection failed"
            exit 1
          fi

      - name: Wait for Galaxy Web UI
        run: |
          echo "Waiting for Galaxy Web UI..."
          for i in {1..30}; do
            if curl -sf http://localhost:8080/api/galaxy/pulp/api/v3/status/ > /dev/null 2>&1; then
              echo "Galaxy Web UI is ready!"
              exit 0
            fi
            echo "Waiting for Galaxy Web UI... ($i/30)"
            sleep 5
          done
          echo "Galaxy Web UI failed to start"
          docker compose logs galaxy-web
          exit 1

      - name: Test Galaxy Web login
        run: |
          echo "=== Testing Galaxy Web Login ==="
          
          LOGIN_PAGE=$(curl -s -c /tmp/cookies.txt -b /tmp/cookies.txt http://localhost:8080/login/)
          CSRF_TOKEN=$(echo "$LOGIN_PAGE" | grep -oP 'name="csrfmiddlewaretoken" value="\K[^"]+' | head -1)
          
          if [ -z "$CSRF_TOKEN" ]; then
            echo "Failed to get CSRF token"
            exit 1
          fi
          
          echo "CSRF token obtained: ${CSRF_TOKEN:0:10}..."
          
          LOGIN_RESPONSE=$(curl -s -w "%{http_code}" -c /tmp/cookies.txt -b /tmp/cookies.txt \
            -X POST http://localhost:8080/login/ \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "csrfmiddlewaretoken=$CSRF_TOKEN&username=admin&password=admin&remember=on")
          
          HTTP_CODE="${LOGIN_RESPONSE: -3}"
          BODY="${LOGIN_RESPONSE:0:-3}"
          
          echo "Login response code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" == "302" ] || [ "$HTTP_CODE" == "200" ]; then
            AUTH_CHECK=$(curl -s -b /tmp/cookies.txt http://localhost:8080/api/galaxy/pulp/api/v3/status/)
            if echo "$AUTH_CHECK" | jq -e . > /dev/null 2>&1; then
              echo "Galaxy Web login successful!"
            else
              echo "Login returned success but authenticated request failed"
            fi
          else
            echo "Login failed with code: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      - name: Test Galaxy API login
        run: |
          echo "=== Testing Galaxy API Login ==="
          
          LOGIN_PAGE=$(curl -s -c /tmp/api_cookies.txt -b /tmp/api_cookies.txt http://localhost:8000/api/galaxy/v3/auth/login/)
          CSRF_TOKEN=$(echo "$LOGIN_PAGE" | grep -oP 'name="csrfmiddlewaretoken" value="\K[^"]+' | head -1)
          
          if [ -z "$CSRF_TOKEN" ]; then
            echo "Using session-based authentication..."
            SESSION_RESPONSE=$(curl -s -w "%{http_code}" -c /tmp/api_cookies.txt -b /tmp/api_cookies.txt \
              -X POST http://localhost:8000/api/galaxy/v3/auth/login/ \
              -H "Content-Type: application/json" \
              -d '{"username":"admin","password":"admin"}')
            
            HTTP_CODE="${SESSION_RESPONSE: -3}"
            echo "API login response code: $HTTP_CODE"
            
            if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "204" ]; then
              echo "Galaxy API authentication successful!"
            else
              echo "API login response: ${SESSION_RESPONSE:0:-3}"
            fi
          else
            LOGIN_RESPONSE=$(curl -s -w "%{http_code}" -c /tmp/api_cookies.txt -b /tmp/api_cookies.txt \
              -X POST http://localhost:8000/api/galaxy/v3/auth/login/ \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "csrfmiddlewaretoken=$CSRF_TOKEN&username=admin&password=admin")
            
            HTTP_CODE="${LOGIN_RESPONSE: -3}"
            echo "API login response code: $HTTP_CODE"
            
            if [ "$HTTP_CODE" == "302" ]; then
              echo "Galaxy API authentication successful!"
            fi
          fi

      - name: Stop services
        if: always()
        run: docker compose down -v

  backup-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Copy environment file
        run: |
          cp .env.ci .env

      - name: Start services
        run: docker compose up -d

      - name: Wait for services
        run: sleep 60

      - name: Test backup script
        run: |
          chmod +x scripts/backup.sh
          mkdir -p backups
          ./scripts/backup.sh

      - name: Verify backup created
        run: |
          echo "Backups created:"
          ls -la backups/
          BACKUP_COUNT=$(find backups -name "galaxy_backup_*.tar.gz" | wc -l)
          echo "Total backups: $BACKUP_COUNT"
          if [ "$BACKUP_COUNT" -eq 0 ]; then
            echo "No backups found!"
            exit 1
          fi

      - name: Stop services
        if: always()
        run: docker compose down -v
