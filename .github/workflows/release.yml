name: Release Galaxy Collection

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Copy environment file
        run: cp .env.ci .env

      - name: Start services
        run: docker compose up -d

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to be ready..."
          sleep 60
          for i in {1..60}; do
            if curl -sf http://localhost:8000/api/galaxy/pulp/api/v3/status/ > /dev/null 2>&1; then
              echo "Services are ready"
              exit 0
            fi
            echo "Waiting... ($i/60)"
            sleep 5
          done
          echo "Services failed to start"
          docker compose logs
          exit 1

      - name: Build collection
        run: |
          cd galaxy_service
          ansible-galaxy collection build

      - name: Upload collection artifact
        uses: actions/upload-artifact@v4
        with:
          name: galaxy-collection
          path: galaxy_service/galaxy_service-*.tar.gz

      - name: Load environment variables
        run: |
          source .env.ci
          # Use full URL without removing prefix
          echo "GALAXY_SERVER=$GALAXY_API_HOSTNAME" >> $GITHUB_ENV
          echo "GALAXY_USERNAME=$GALAXY_ADMIN_USER" >> $GITHUB_ENV
          echo "GALAXY_PASSWORD=$GALAXY_ADMIN_PASSWORD" >> $GITHUB_ENV

      - name: Get API Key
        run: |
          echo "Getting Galaxy API key..."
          echo "Server: ${{ env.GALAXY_SERVER }}"
          echo "Username: ${{ env.GALAXY_USERNAME }}"
          
          # Step 1: Get login page and CSRF token
          LOGIN_PAGE=$(curl -s -c /tmp/cookies.txt ${{ env.GALAXY_SERVER }}/auth/login/)
          CSRF_TOKEN=$(echo "$LOGIN_PAGE" | grep -o 'csrfmiddlewaretoken" value="[^"]*"' | sed 's/csrfmiddlewaretoken" value="//;s/"$//' | head -1)
          echo "CSRF Token: ${CSRF_TOKEN:0:20}..."
          
          if [ -z "$CSRF_TOKEN" ]; then
            echo "Failed to get CSRF token"
            echo "Login page content: $LOGIN_PAGE"
            exit 1
          fi
          
          # Step 2: Login to get session cookie
          LOGIN_RESPONSE=$(curl -s -c /tmp/cookies.txt -b /tmp/cookies.txt -X POST "${{ env.GALAXY_SERVER }}/auth/login/" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "csrfmiddlewaretoken=$CSRF_TOKEN&username=${{ env.GALAXY_USERNAME }}&password=${{ env.GALAXY_PASSWORD }}&next=/" \
            -w "%{http_code}" -o /dev/null)
          echo "Login response: $LOGIN_RESPONSE"
          
          # Step 3: Get CSRF token from cookie
          CSRF=$(grep csrftoken /tmp/cookies.txt | awk '{print $7}')
          echo "Session CSRF: ${CSRF:0:20}..."
          
          if [ -z "$CSRF" ]; then
            echo "Failed to get CSRF from cookie"
            cat /tmp/cookies.txt
            exit 1
          fi
          
          # Step 4: Get API token using session and CSRF
          TOKEN_RESPONSE=$(curl -s -b /tmp/cookies.txt -X POST "${{ env.GALAXY_SERVER }}/api/galaxy/v3/auth/token/" \
            -H "Content-Type: application/json" \
            -H "X-CSRFToken: $CSRF" \
            -d "{\"username\":\"${{ env.GALAXY_USERNAME }}\",\"password\":\"${{ env.GALAXY_PASSWORD }}\"}")
          
          echo "Token response: $TOKEN_RESPONSE"
          
          API_KEY=$(echo "$TOKEN_RESPONSE" | grep -oP '(?<="token":")[^"]+' | head -1)
          
          if [ -z "$API_KEY" ]; then
            echo "Failed to get API key"
            echo "Response: $TOKEN_RESPONSE"
            exit 1
          fi
          
          echo "GALAXY_API_KEY=$API_KEY" >> $GITHUB_ENV

      - name: Publish to Galaxy
        run: |
          ansible-galaxy collection publish galaxy_service-*.tar.gz \
            --server=${{ env.GALAXY_SERVER }} \
            --api-key=${{ env.GALAXY_API_KEY }}

      - name: Stop services
        if: always()
        run: docker compose down -v

  create-release:
    needs: [build-and-publish]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download collection artifact
        uses: actions/download-artifact@v4
        with:
          name: galaxy-collection
          path: .

      - name: Package docker-compose files
        run: |
          tar -czvf ansible-galaxy-compose.tar.gz \
            docker-compose.yml \
            .env.example \
            .env.ci \
            .gitignore \
            LICENSE \
            Makefile \
            README.md \
            README.zh-CN.md \
            ansible.cfg \
            certs/ \
            config/ \
            galaxy_service/ \
            init-scripts/ \
            nginx/ \
            scripts/ \
            .github/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ansible-galaxy-compose.tar.gz
            galaxy_service-*.tar.gz
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
