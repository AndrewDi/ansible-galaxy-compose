name: Release Galaxy Collection

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      service_url: ${{ steps.set_url.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Copy environment file
        run: cp .env.ci .env

      - name: Start services
        run: docker compose up -d

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to be ready..."
          sleep 30
          for i in {1..30}; do
            if curl -sf http://localhost:8000/api/galaxy/pulp/api/v3/status/ > /dev/null 2>&1; then
              echo "Services are ready"
              exit 0
            fi
            echo "Waiting... ($i/30)"
            sleep 10
          done
          echo "Services failed to start"
          docker compose logs
          exit 1

      - name: Set service URL
        id: set_url
        run: echo "url=http://localhost:8000" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: galaxy_collection

      - name: Copy environment file
        run: cp .env.ci .env

      - name: Build collection
        run: |
          cd galaxy_collection/galaxy_service
          ansible-galaxy collection build

      - name: Upload collection artifact
        uses: actions/upload-artifact@v4
        with:
          name: galaxy-collection
          path: galaxy_collection/galaxy_service/galaxy_service-*.tar.gz

  publish-galaxy:
    needs: [deploy, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download collection artifact
        uses: actions/download-artifact@v4
        with:
          name: galaxy-collection
          path: .

      - name: Get collection name
        id: collection
        run: |
          COLLECTION_FILE=$(ls galaxy_service-*.tar.gz | head -1)
          echo "file=$COLLECTION_FILE" >> $GITHUB_OUTPUT
          echo "name=${COLLECTION_FILE%.tar.gz}" >> $GITHUB_OUTPUT

      - name: Load environment variables
        run: |
          source .env.ci
          echo "GALAXY_SERVER=$GALAXY_API_HOSTNAME" >> $GITHUB_ENV
          echo "GALAXY_USERNAME=$GALAXY_ADMIN_USER" >> $GITHUB_ENV
          echo "GALAXY_PASSWORD=$GALAXY_ADMIN_PASSWORD" >> $GITHUB_ENV

      - name: Publish to local Galaxy
        if: github.event_name == 'workflow_dispatch'
        uses: ansible/galaxy-action@main
        with:
          username: ${{ env.GALAXY_USERNAME }}
          password: ${{ env.GALAXY_PASSWORD }}
          collection_path: .
          distribution: galaxy

      - name: Publish to Ansible Galaxy
        if: github.event_name == 'release'
        uses: ansible/galaxy-action@main
        with:
          username: ${{ env.GALAXY_USERNAME }}
          password: ${{ env.GALAXY_PASSWORD }}
          collection_path: .
          distribution: ansible

  cleanup:
    needs: [deploy, build, publish-galaxy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Stop services
        run: docker compose down -v || true
