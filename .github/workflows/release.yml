name: Release Galaxy Collection

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      service_url: ${{ steps.set_url.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Copy environment file
        run: cp .env.ci .env

      - name: Start services
        run: docker compose up -d

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to be ready..."
          sleep 30
          for i in {1..30}; do
            if curl -sf http://localhost:8000/api/galaxy/pulp/api/v3/status/ > /dev/null 2>&1; then
              echo "Services are ready"
              exit 0
            fi
            echo "Waiting... ($i/30)"
            sleep 10
          done
          echo "Services failed to start"
          docker compose logs
          exit 1

      - name: Set service URL
        id: set_url
        run: echo "url=http://localhost:8000" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: galaxy_collection

      - name: Build collection
        run: |
          cd galaxy_collection/galaxy_service
          ansible-galaxy collection build

      - name: Upload collection artifact
        uses: actions/upload-artifact@v4
        with:
          name: galaxy-collection
          path: galaxy_collection/galaxy_service/galaxy_service-*.tar.gz

  publish-galaxy:
    needs: [deploy, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download collection artifact
        uses: actions/download-artifact@v4
        with:
          name: galaxy-collection
          path: .

      - name: Load environment variables
        run: |
          source .env.ci
          echo "GALAXY_SERVER=$GALAXY_API_HOSTNAME" >> $GITHUB_ENV
          echo "GALAXY_USERNAME=$GALAXY_ADMIN_USER" >> $GITHUB_ENV
          echo "GALAXY_PASSWORD=$GALAXY_ADMIN_PASSWORD" >> $GITHUB_ENV

      - name: Get API Key
        run: |
          echo "Getting Galaxy API key..."
          TOKEN_RESPONSE=$(curl -s -X POST "${{ env.GALAXY_SERVER }}/api/galaxy/v3/auth/token/" \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"${{ env.GALAXY_USERNAME }}\",\"password\":\"${{ env.GALAXY_PASSWORD }}\"}")
          
          echo "Token response: $TOKEN_RESPONSE"
          
          API_KEY=$(echo "$TOKEN_RESPONSE" | grep -oP '(?<="token":")[^"]+' | head -1)
          
          if [ -z "$API_KEY" ]; then
            echo "Failed to get API key"
            echo "Response: $TOKEN_RESPONSE"
            exit 1
          fi
          
          echo "GALAXY_API_KEY=$API_KEY" >> $GITHUB_OUTPUT

      - name: Publish to local Galaxy
        if: github.event_name == 'workflow_dispatch'
        run: |
          ansible-galaxy collection publish galaxy_service-*.tar.gz \
            --server=${{ env.GALAXY_SERVER }} \
            --api-key=${{ env.GALAXY_API_KEY }}

      - name: Publish to Ansible Galaxy
        if: github.event_name == 'release'
        run: |
          ansible-galaxy collection publish galaxy_service-*.tar.gz \
            --api-key=${{ env.GALAXY_API_KEY }}

  create-release:
    needs: [deploy, build, publish-galaxy]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download collection artifact
        uses: actions/download-artifact@v4
        with:
          name: galaxy-collection
          path: .

      - name: Package docker-compose files
        run: |
          tar -czvf ansible-galaxy-compose.tar.gz \
            docker-compose.yml \
            .env.example \
            .env.ci \
            .gitignore \
            LICENSE \
            Makefile \
            README.md \
            README.zh-CN.md \
            ansible.cfg \
            certs/ \
            config/ \
            galaxy_service/ \
            init-scripts/ \
            nginx/ \
            scripts/ \
            .github/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ansible-galaxy-compose.tar.gz
            galaxy_service-*.tar.gz
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    needs: [deploy, build, publish-galaxy, create-release]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Stop services
        run: docker compose down -v || true
